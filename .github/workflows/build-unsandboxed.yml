name: Build Unsandboxed

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
            echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=" >> "$GITHUB_OUTPUT"
            echo "version=dev-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          fi

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer

      - name: Import signing certificate
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          # Create a temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Decode and import the certificate
          echo "$CERTIFICATE_P12" | base64 --decode > "$RUNNER_TEMP/certificate.p12"
          security import "$RUNNER_TEMP/certificate.p12" \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Add keychain to search list
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          # Allow codesign to access the key without prompting
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Find the signing identity
          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | head -1 | grep -o '".*"' | tr -d '"')
          echo "SIGNING_IDENTITY=$IDENTITY" >> "$GITHUB_ENV"

      - name: Build archive
        run: |
          xcodebuild archive \
            -project "Task Visualiser.xcodeproj" \
            -scheme "Task Visualiser" \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/TaskVisualiser.xcarchive" \
            MACOSX_DEPLOYMENT_TARGET=15.0 \
            ENABLE_APP_SANDBOX=NO \
            CODE_SIGN_IDENTITY="$SIGNING_IDENTITY" \
            CODE_SIGN_ENTITLEMENTS="Task Visualiser/Task Visualiser.unsandboxed.entitlements" \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=NO

      - name: Export app
        run: |
          mkdir -p "$RUNNER_TEMP/export"
          cp -R "$RUNNER_TEMP/TaskVisualiser.xcarchive/Products/Applications/Task Visualiser.app" "$RUNNER_TEMP/export/"

      - name: Sign app bundle
        run: |
          codesign --force --deep --options runtime \
            --sign "$SIGNING_IDENTITY" \
            "$RUNNER_TEMP/export/Task Visualiser.app"

      - name: Create DMG
        run: |
          mkdir -p "$RUNNER_TEMP/dmg-contents"
          cp -R "$RUNNER_TEMP/export/Task Visualiser.app" "$RUNNER_TEMP/dmg-contents/"
          ln -s /Applications "$RUNNER_TEMP/dmg-contents/Applications"
          hdiutil create \
            -volname "Task Visualiser" \
            -srcfolder "$RUNNER_TEMP/dmg-contents" \
            -ov \
            -format UDZO \
            "$RUNNER_TEMP/export/TaskVisualiser-${{ steps.version.outputs.version }}.dmg"
          codesign --force --sign "$SIGNING_IDENTITY" \
            "$RUNNER_TEMP/export/TaskVisualiser-${{ steps.version.outputs.version }}.dmg"

      - name: Notarize DMG
        env:
          NOTARY_KEY_P8: ${{ secrets.NOTARY_KEY_P8 }}
          NOTARY_KEY_ID: ${{ secrets.NOTARY_KEY_ID }}
          NOTARY_ISSUER_ID: ${{ secrets.NOTARY_ISSUER_ID }}
        run: |
          # Write the API key
          mkdir -p "$RUNNER_TEMP/notary"
          echo "$NOTARY_KEY_P8" | base64 --decode > "$RUNNER_TEMP/notary/AuthKey_${NOTARY_KEY_ID}.p8"

          # Submit for notarization and wait
          xcrun notarytool submit \
            "$RUNNER_TEMP/export/TaskVisualiser-${{ steps.version.outputs.version }}.dmg" \
            --key "$RUNNER_TEMP/notary/AuthKey_${NOTARY_KEY_ID}.p8" \
            --key-id "$NOTARY_KEY_ID" \
            --issuer "$NOTARY_ISSUER_ID" \
            --wait

          # Staple the notarization ticket to the DMG
          xcrun stapler staple \
            "$RUNNER_TEMP/export/TaskVisualiser-${{ steps.version.outputs.version }}.dmg"

      - name: Clean up secrets
        if: always()
        run: |
          security delete-keychain "$RUNNER_TEMP/build.keychain-db" 2>/dev/null || true
          rm -f "$RUNNER_TEMP/certificate.p12"
          rm -rf "$RUNNER_TEMP/notary"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: TaskVisualiser-${{ steps.version.outputs.version }}
          path: ${{ runner.temp }}/export/TaskVisualiser-${{ steps.version.outputs.version }}.dmg

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          name: Task Visualiser ${{ steps.version.outputs.tag }}
          draft: false
          generate_release_notes: true
          files: ${{ runner.temp }}/export/TaskVisualiser-${{ steps.version.outputs.version }}.dmg
